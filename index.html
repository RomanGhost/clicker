<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Clicker Frontend</title>
  <!-- Подключаем React и Babel через CDN -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    input, button {
      padding: 8px;
      margin: 4px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">

    // Функция для вычисления SHA-256 хеша в виде шестнадцатеричной строки
    async function sha256(message) {
      const encoder = new TextEncoder();
      const data = encoder.encode(message);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
      return hashHex;
    }
    
    function App() {
      const [loggedIn, setLoggedIn] = React.useState(false);
      const [username, setUsername] = React.useState("");
      const [validClicks, setValidClicks] = React.useState(0);
      const [totalClicks, setTotalClicks] = React.useState(0);
      const [loading, setLoading] = React.useState(false);
      
      // Функция для логина (отправляет запрос на /login)
      const handleLogin = async () => {
        if(username.trim() === "") return alert("Введите логин");
        try {
          const response = await fetch("/login", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ username })
          });
          if(response.ok) {
            setLoggedIn(true);
          } else {
            alert("Ошибка логина");
          }
        } catch (error) {
          console.error(error);
          alert("Ошибка запроса");
        }
      };
      
      // Функция для клика
      const handleClick = async () => {
        setLoading(true);
        // Ищем nonce, для которого хеш строки "логин_валидныеКлики_nonce" начинается с "000"
        let nonce = 0;
        let validNonce = null;
        while (true) {
          const data = `${username}_${validClicks}_${nonce}`;
          const hash = await sha256(data);
          if(hash.startsWith("000")) {
            validNonce = nonce;
            break;
          }
          nonce++;
        }
        // Отправляем запрос на клик с найденным nonce
        try {
          const response = await fetch("/click", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ username, nonce: validNonce })
          });
          if(response.ok) {
            const result = await response.json();
            // Ожидается, что сервер вернёт { validClicks, totalClicks }
            setValidClicks(result.validClicks);
            setTotalClicks(result.totalClicks);
          } else {
            alert("Ошибка клика");
          }
        } catch (error) {
          console.error(error);
          alert("Ошибка запроса");
        }
        setLoading(false);
      };
      
      return (
        <div style={{ padding: "20px", background: "#fff", borderRadius: "8px", maxWidth: "400px", margin: "0 auto" }}>
          { loggedIn ? (
            <div>
              <h1>Привет, {username}!</h1>
              <p><strong>Валидных кликов:</strong> {validClicks}</p>
              <p><strong>Общее количество кликов:</strong> {totalClicks}</p>
              <button onClick={handleClick} disabled={loading}>
                {loading ? "Подсчет..." : "Клик!"}
              </button>
            </div>
          ) : (
            <div>
              <h1>Вход</h1>
              <input 
                type="text" 
                placeholder="Введите логин" 
                value={username} 
                onChange={(e) => setUsername(e.target.value)} 
              />
              <button onClick={handleLogin}>Войти</button>
            </div>
          )}
        </div>
      );
    }
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
